"use strict";
/**
 * Market Data Stream Service
 * Fetches live weather data from Open-Meteo API for Winter Haven, Florida
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchWeatherData = fetchWeatherData;
exports.fetchLiveMarketData = fetchLiveMarketData;
exports.formatSyncTime = formatSyncTime;
exports.getFrostRiskLevel = getFrostRiskLevel;
// Winter Haven, Florida coordinates - heart of the citrus industry
const WINTER_HAVEN_LAT = 28.02;
const WINTER_HAVEN_LON = -81.73;
// Weather code to condition mapping (WMO Weather interpretation codes)
const WEATHER_CODE_MAP = {
    0: "Clear",
    1: "Mainly Clear",
    2: "Partly Cloudy",
    3: "Overcast",
    45: "Foggy",
    48: "Depositing Rime Fog",
    51: "Light Drizzle",
    53: "Moderate Drizzle",
    55: "Dense Drizzle",
    56: "Light Freezing Drizzle",
    57: "Dense Freezing Drizzle",
    61: "Slight Rain",
    63: "Moderate Rain",
    65: "Heavy Rain",
    66: "Light Freezing Rain",
    67: "Heavy Freezing Rain",
    71: "Slight Snow",
    73: "Moderate Snow",
    75: "Heavy Snow",
    77: "Snow Grains",
    80: "Slight Rain Showers",
    81: "Moderate Rain Showers",
    82: "Violent Rain Showers",
    85: "Slight Snow Showers",
    86: "Heavy Snow Showers",
    95: "Thunderstorm",
    96: "Thunderstorm with Slight Hail",
    99: "Thunderstorm with Heavy Hail",
};
/**
 * Converts Celsius to Fahrenheit
 */
function celsiusToFahrenheit(celsius) {
    return Math.round((celsius * 9) / 5 + 32);
}
/**
 * Converts km/h to mph
 */
function kmhToMph(kmh) {
    return Math.round(kmh * 0.621371);
}
/**
 * Gets the condition string from weather code
 */
function getConditionFromCode(code, temp) {
    // Add freeze warning context if temperature is low
    if (temp <= 32) {
        if (code === 0 || code === 1)
            return "Clear - FREEZE WARNING";
        return `${WEATHER_CODE_MAP[code] || "Unknown"} - FREEZE WARNING`;
    }
    if (temp <= 36) {
        if (code === 0 || code === 1)
            return "Clear - Frost Advisory";
        return `${WEATHER_CODE_MAP[code] || "Unknown"} - Frost Advisory`;
    }
    return WEATHER_CODE_MAP[code] || "Unknown";
}
/**
 * Fetches real weather data from Open-Meteo API for Winter Haven, FL
 */
async function fetchWeatherData() {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${WINTER_HAVEN_LAT}&longitude=${WINTER_HAVEN_LON}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&temperature_unit=celsius&wind_speed_unit=kmh&timezone=America%2FNew_York`;
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Weather API error: ${response.status}`);
        }
        const data = await response.json();
        const current = data.current;
        const tempFahrenheit = celsiusToFahrenheit(current.temperature_2m);
        const windSpeedMph = kmhToMph(current.wind_speed_10m);
        const weatherCode = current.weather_code;
        return {
            temperature: tempFahrenheit,
            humidity: Math.round(current.relative_humidity_2m),
            windSpeed: windSpeedMph,
            condition: getConditionFromCode(weatherCode, tempFahrenheit),
            weatherCode,
            isFreezingConditions: tempFahrenheit <= 32,
            isFreezeWarning: tempFahrenheit <= 36,
            timestamp: new Date(),
        };
    }
    catch (error) {
        console.error("Failed to fetch weather data:", error);
        // Return fallback data on error
        return {
            temperature: 45,
            humidity: 70,
            windSpeed: 5,
            condition: "Data Unavailable",
            weatherCode: -1,
            isFreezingConditions: false,
            isFreezeWarning: false,
            timestamp: new Date(),
        };
    }
}
/**
 * Fetches live market data including real weather
 * Combines real weather API data with simulated inventory data
 */
async function fetchLiveMarketData() {
    // Fetch real weather data
    const weather = await fetchWeatherData();
    // Simulate inventory levels (this would come from USDA/ICE data in production)
    const inventoryBase = 35 + Math.random() * 20;
    const inventoryVariance = (Math.random() - 0.5) * 30;
    const inventory = Math.round(Math.max(20, Math.min(70, inventoryBase + inventoryVariance)));
    // Hurricane alert based on weather conditions (simplified)
    // In production, this would check NHC/NOAA hurricane data
    const isHurricaneAlert = weather.weatherCode >= 95 || // Thunderstorm conditions
        (weather.windSpeed > 40 && weather.weatherCode >= 80); // High winds + rain
    return {
        weather,
        marketData: {
            currentTemp: weather.temperature,
            inventory,
            isHurricaneAlert,
            timestamp: weather.timestamp,
        },
    };
}
/**
 * Formats the timestamp for display
 */
function formatSyncTime(date) {
    return date.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
    });
}
/**
 * Gets frost risk level based on temperature and conditions
 */
function getFrostRiskLevel(temp, humidity, windSpeed) {
    // High humidity + low wind + low temp = higher frost risk
    // Wind actually reduces frost risk by preventing radiative cooling
    if (temp > 40) {
        return { level: "none", description: "No frost risk" };
    }
    if (temp > 36) {
        if (windSpeed < 5 && humidity > 70) {
            return { level: "low", description: "Slight frost possible overnight" };
        }
        return { level: "none", description: "No significant frost risk" };
    }
    if (temp > 32) {
        if (windSpeed < 5 && humidity > 60) {
            return { level: "moderate", description: "Frost likely overnight" };
        }
        return { level: "low", description: "Light frost possible" };
    }
    if (temp > 28) {
        if (windSpeed < 10) {
            return { level: "high", description: "Hard freeze expected" };
        }
        return { level: "moderate", description: "Freeze conditions" };
    }
    // Below 28Â°F - critical for citrus
    return { level: "critical", description: "CRITICAL: Citrus damage likely" };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2V0RGF0YVN0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9tYXJrZXREYXRhU3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBOEZILDRDQXlDQztBQU1ELGtEQTBCQztBQUtELHdDQU1DO0FBS0QsOENBbUNDO0FBeE5ELG1FQUFtRTtBQUNuRSxNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQUMvQixNQUFNLGdCQUFnQixHQUFHLENBQUMsS0FBSyxDQUFDO0FBeUJoQyx1RUFBdUU7QUFDdkUsTUFBTSxnQkFBZ0IsR0FBMkI7SUFDL0MsQ0FBQyxFQUFFLE9BQU87SUFDVixDQUFDLEVBQUUsY0FBYztJQUNqQixDQUFDLEVBQUUsZUFBZTtJQUNsQixDQUFDLEVBQUUsVUFBVTtJQUNiLEVBQUUsRUFBRSxPQUFPO0lBQ1gsRUFBRSxFQUFFLHFCQUFxQjtJQUN6QixFQUFFLEVBQUUsZUFBZTtJQUNuQixFQUFFLEVBQUUsa0JBQWtCO0lBQ3RCLEVBQUUsRUFBRSxlQUFlO0lBQ25CLEVBQUUsRUFBRSx3QkFBd0I7SUFDNUIsRUFBRSxFQUFFLHdCQUF3QjtJQUM1QixFQUFFLEVBQUUsYUFBYTtJQUNqQixFQUFFLEVBQUUsZUFBZTtJQUNuQixFQUFFLEVBQUUsWUFBWTtJQUNoQixFQUFFLEVBQUUscUJBQXFCO0lBQ3pCLEVBQUUsRUFBRSxxQkFBcUI7SUFDekIsRUFBRSxFQUFFLGFBQWE7SUFDakIsRUFBRSxFQUFFLGVBQWU7SUFDbkIsRUFBRSxFQUFFLFlBQVk7SUFDaEIsRUFBRSxFQUFFLGFBQWE7SUFDakIsRUFBRSxFQUFFLHFCQUFxQjtJQUN6QixFQUFFLEVBQUUsdUJBQXVCO0lBQzNCLEVBQUUsRUFBRSxzQkFBc0I7SUFDMUIsRUFBRSxFQUFFLHFCQUFxQjtJQUN6QixFQUFFLEVBQUUsb0JBQW9CO0lBQ3hCLEVBQUUsRUFBRSxjQUFjO0lBQ2xCLEVBQUUsRUFBRSwr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QixFQUFFLENBQUM7SUFDakUsQ0FBQztJQUVELG1DQUFtQztJQUNuQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQztBQUM5RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNYXJrZXQgRGF0YSBTdHJlYW0gU2VydmljZVxuICogRmV0Y2hlcyBsaXZlIHdlYXRoZXIgZGF0YSBmcm9tIE9wZW4tTWV0ZW8gQVBJIGZvciBXaW50ZXIgSGF2ZW4sIEZsb3JpZGFcbiAqL1xuXG4vLyBXaW50ZXIgSGF2ZW4sIEZsb3JpZGEgY29vcmRpbmF0ZXMgLSBoZWFydCBvZiB0aGUgY2l0cnVzIGluZHVzdHJ5XG5jb25zdCBXSU5URVJfSEFWRU5fTEFUID0gMjguMDI7XG5jb25zdCBXSU5URVJfSEFWRU5fTE9OID0gLTgxLjczO1xuXG5leHBvcnQgaW50ZXJmYWNlIExpdmVNYXJrZXREYXRhIHtcbiAgY3VycmVudFRlbXA6IG51bWJlcjtcbiAgaW52ZW50b3J5OiBudW1iZXI7XG4gIGlzSHVycmljYW5lQWxlcnQ6IGJvb2xlYW47XG4gIHRpbWVzdGFtcDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXZWF0aGVyRGF0YSB7XG4gIHRlbXBlcmF0dXJlOiBudW1iZXI7IC8vIEZhaHJlbmhlaXRcbiAgaHVtaWRpdHk6IG51bWJlcjsgLy8gUGVyY2VudGFnZVxuICB3aW5kU3BlZWQ6IG51bWJlcjsgLy8gbXBoXG4gIGNvbmRpdGlvbjogc3RyaW5nOyAvLyBlLmcuLCBcIkNsZWFyXCIsIFwiQ2xvdWR5XCIsIFwiUmFpblwiXG4gIHdlYXRoZXJDb2RlOiBudW1iZXI7XG4gIGlzRnJlZXppbmdDb25kaXRpb25zOiBib29sZWFuO1xuICBpc0ZyZWV6ZVdhcm5pbmc6IGJvb2xlYW47XG4gIHRpbWVzdGFtcDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMaXZlV2VhdGhlclJlc3BvbnNlIHtcbiAgd2VhdGhlcjogV2VhdGhlckRhdGE7XG4gIG1hcmtldERhdGE6IExpdmVNYXJrZXREYXRhO1xufVxuXG4vLyBXZWF0aGVyIGNvZGUgdG8gY29uZGl0aW9uIG1hcHBpbmcgKFdNTyBXZWF0aGVyIGludGVycHJldGF0aW9uIGNvZGVzKVxuY29uc3QgV0VBVEhFUl9DT0RFX01BUDogUmVjb3JkPG51bWJlciwgc3RyaW5nPiA9IHtcbiAgMDogXCJDbGVhclwiLFxuICAxOiBcIk1haW5seSBDbGVhclwiLFxuICAyOiBcIlBhcnRseSBDbG91ZHlcIixcbiAgMzogXCJPdmVyY2FzdFwiLFxuICA0NTogXCJGb2dneVwiLFxuICA0ODogXCJEZXBvc2l0aW5nIFJpbWUgRm9nXCIsXG4gIDUxOiBcIkxpZ2h0IERyaXp6bGVcIixcbiAgNTM6IFwiTW9kZXJhdGUgRHJpenpsZVwiLFxuICA1NTogXCJEZW5zZSBEcml6emxlXCIsXG4gIDU2OiBcIkxpZ2h0IEZyZWV6aW5nIERyaXp6bGVcIixcbiAgNTc6IFwiRGVuc2UgRnJlZXppbmcgRHJpenpsZVwiLFxuICA2MTogXCJTbGlnaHQgUmFpblwiLFxuICA2MzogXCJNb2RlcmF0ZSBSYWluXCIsXG4gIDY1OiBcIkhlYXZ5IFJhaW5cIixcbiAgNjY6IFwiTGlnaHQgRnJlZXppbmcgUmFpblwiLFxuICA2NzogXCJIZWF2eSBGcmVlemluZyBSYWluXCIsXG4gIDcxOiBcIlNsaWdodCBTbm93XCIsXG4gIDczOiBcIk1vZGVyYXRlIFNub3dcIixcbiAgNzU6IFwiSGVhdnkgU25vd1wiLFxuICA3NzogXCJTbm93IEdyYWluc1wiLFxuICA4MDogXCJTbGlnaHQgUmFpbiBTaG93ZXJzXCIsXG4gIDgxOiBcIk1vZGVyYXRlIFJhaW4gU2hvd2Vyc1wiLFxuICA4MjogXCJWaW9sZW50IFJhaW4gU2hvd2Vyc1wiLFxuICA4NTogXCJTbGlnaHQgU25vdyBTaG93ZXJzXCIsXG4gIDg2OiBcIkhlYXZ5IFNub3cgU2hvd2Vyc1wiLFxuICA5NTogXCJUaHVuZGVyc3Rvcm1cIixcbiAgOTY6IFwiVGh1bmRlcnN0b3JtIHdpdGggU2xpZ2h0IEhhaWxcIixcbiAgOTk6IFwiVGh1bmRlcnN0b3JtIHdpdGggSGVhdnkgSGFpbFwiLFxufTtcblxuLyoqXG4gKiBDb252ZXJ0cyBDZWxzaXVzIHRvIEZhaHJlbmhlaXRcbiAqL1xuZnVuY3Rpb24gY2Vsc2l1c1RvRmFocmVuaGVpdChjZWxzaXVzOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gTWF0aC5yb3VuZCgoY2Vsc2l1cyAqIDkpIC8gNSArIDMyKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0cyBrbS9oIHRvIG1waFxuICovXG5mdW5jdGlvbiBrbWhUb01waChrbWg6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiBNYXRoLnJvdW5kKGttaCAqIDAuNjIxMzcxKTtcbn1cblxuLyoqXG4gKiBHZXRzIHRoZSBjb25kaXRpb24gc3RyaW5nIGZyb20gd2VhdGhlciBjb2RlXG4gKi9cbmZ1bmN0aW9uIGdldENvbmRpdGlvbkZyb21Db2RlKGNvZGU6IG51bWJlciwgdGVtcDogbnVtYmVyKTogc3RyaW5nIHtcbiAgLy8gQWRkIGZyZWV6ZSB3YXJuaW5nIGNvbnRleHQgaWYgdGVtcGVyYXR1cmUgaXMgbG93XG4gIGlmICh0ZW1wIDw9IDMyKSB7XG4gICAgaWYgKGNvZGUgPT09IDAgfHwgY29kZSA9PT0gMSkgcmV0dXJuIFwiQ2xlYXIgLSBGUkVFWkUgV0FSTklOR1wiO1xuICAgIHJldHVybiBgJHtXRUFUSEVSX0NPREVfTUFQW2NvZGVdIHx8IFwiVW5rbm93blwifSAtIEZSRUVaRSBXQVJOSU5HYDtcbiAgfVxuICBpZiAodGVtcCA8PSAzNikge1xuICAgIGlmIChjb2RlID09PSAwIHx8IGNvZGUgPT09IDEpIHJldHVybiBcIkNsZWFyIC0gRnJvc3QgQWR2aXNvcnlcIjtcbiAgICByZXR1cm4gYCR7V0VBVEhFUl9DT0RFX01BUFtjb2RlXSB8fCBcIlVua25vd25cIn0gLSBGcm9zdCBBZHZpc29yeWA7XG4gIH1cbiAgcmV0dXJuIFdFQVRIRVJfQ09ERV9NQVBbY29kZV0gfHwgXCJVbmtub3duXCI7XG59XG5cbi8qKlxuICogRmV0Y2hlcyByZWFsIHdlYXRoZXIgZGF0YSBmcm9tIE9wZW4tTWV0ZW8gQVBJIGZvciBXaW50ZXIgSGF2ZW4sIEZMXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaFdlYXRoZXJEYXRhKCk6IFByb21pc2U8V2VhdGhlckRhdGE+IHtcbiAgY29uc3QgdXJsID0gYGh0dHBzOi8vYXBpLm9wZW4tbWV0ZW8uY29tL3YxL2ZvcmVjYXN0P2xhdGl0dWRlPSR7V0lOVEVSX0hBVkVOX0xBVH0mbG9uZ2l0dWRlPSR7V0lOVEVSX0hBVkVOX0xPTn0mY3VycmVudD10ZW1wZXJhdHVyZV8ybSxyZWxhdGl2ZV9odW1pZGl0eV8ybSx3ZWF0aGVyX2NvZGUsd2luZF9zcGVlZF8xMG0mdGVtcGVyYXR1cmVfdW5pdD1jZWxzaXVzJndpbmRfc3BlZWRfdW5pdD1rbWgmdGltZXpvbmU9QW1lcmljYSUyRk5ld19Zb3JrYDtcblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTtcblxuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgV2VhdGhlciBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgY29uc3QgY3VycmVudCA9IGRhdGEuY3VycmVudDtcblxuICAgIGNvbnN0IHRlbXBGYWhyZW5oZWl0ID0gY2Vsc2l1c1RvRmFocmVuaGVpdChjdXJyZW50LnRlbXBlcmF0dXJlXzJtKTtcbiAgICBjb25zdCB3aW5kU3BlZWRNcGggPSBrbWhUb01waChjdXJyZW50LndpbmRfc3BlZWRfMTBtKTtcbiAgICBjb25zdCB3ZWF0aGVyQ29kZSA9IGN1cnJlbnQud2VhdGhlcl9jb2RlO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRlbXBlcmF0dXJlOiB0ZW1wRmFocmVuaGVpdCxcbiAgICAgIGh1bWlkaXR5OiBNYXRoLnJvdW5kKGN1cnJlbnQucmVsYXRpdmVfaHVtaWRpdHlfMm0pLFxuICAgICAgd2luZFNwZWVkOiB3aW5kU3BlZWRNcGgsXG4gICAgICBjb25kaXRpb246IGdldENvbmRpdGlvbkZyb21Db2RlKHdlYXRoZXJDb2RlLCB0ZW1wRmFocmVuaGVpdCksXG4gICAgICB3ZWF0aGVyQ29kZSxcbiAgICAgIGlzRnJlZXppbmdDb25kaXRpb25zOiB0ZW1wRmFocmVuaGVpdCA8PSAzMixcbiAgICAgIGlzRnJlZXplV2FybmluZzogdGVtcEZhaHJlbmhlaXQgPD0gMzYsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGZldGNoIHdlYXRoZXIgZGF0YTpcIiwgZXJyb3IpO1xuICAgIC8vIFJldHVybiBmYWxsYmFjayBkYXRhIG9uIGVycm9yXG4gICAgcmV0dXJuIHtcbiAgICAgIHRlbXBlcmF0dXJlOiA0NSxcbiAgICAgIGh1bWlkaXR5OiA3MCxcbiAgICAgIHdpbmRTcGVlZDogNSxcbiAgICAgIGNvbmRpdGlvbjogXCJEYXRhIFVuYXZhaWxhYmxlXCIsXG4gICAgICB3ZWF0aGVyQ29kZTogLTEsXG4gICAgICBpc0ZyZWV6aW5nQ29uZGl0aW9uczogZmFsc2UsXG4gICAgICBpc0ZyZWV6ZVdhcm5pbmc6IGZhbHNlLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBGZXRjaGVzIGxpdmUgbWFya2V0IGRhdGEgaW5jbHVkaW5nIHJlYWwgd2VhdGhlclxuICogQ29tYmluZXMgcmVhbCB3ZWF0aGVyIEFQSSBkYXRhIHdpdGggc2ltdWxhdGVkIGludmVudG9yeSBkYXRhXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaExpdmVNYXJrZXREYXRhKCk6IFByb21pc2U8TGl2ZVdlYXRoZXJSZXNwb25zZT4ge1xuICAvLyBGZXRjaCByZWFsIHdlYXRoZXIgZGF0YVxuICBjb25zdCB3ZWF0aGVyID0gYXdhaXQgZmV0Y2hXZWF0aGVyRGF0YSgpO1xuXG4gIC8vIFNpbXVsYXRlIGludmVudG9yeSBsZXZlbHMgKHRoaXMgd291bGQgY29tZSBmcm9tIFVTREEvSUNFIGRhdGEgaW4gcHJvZHVjdGlvbilcbiAgY29uc3QgaW52ZW50b3J5QmFzZSA9IDM1ICsgTWF0aC5yYW5kb20oKSAqIDIwO1xuICBjb25zdCBpbnZlbnRvcnlWYXJpYW5jZSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDMwO1xuICBjb25zdCBpbnZlbnRvcnkgPSBNYXRoLnJvdW5kKFxuICAgIE1hdGgubWF4KDIwLCBNYXRoLm1pbig3MCwgaW52ZW50b3J5QmFzZSArIGludmVudG9yeVZhcmlhbmNlKSlcbiAgKTtcblxuICAvLyBIdXJyaWNhbmUgYWxlcnQgYmFzZWQgb24gd2VhdGhlciBjb25kaXRpb25zIChzaW1wbGlmaWVkKVxuICAvLyBJbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIGNoZWNrIE5IQy9OT0FBIGh1cnJpY2FuZSBkYXRhXG4gIGNvbnN0IGlzSHVycmljYW5lQWxlcnQgPVxuICAgIHdlYXRoZXIud2VhdGhlckNvZGUgPj0gOTUgfHwgLy8gVGh1bmRlcnN0b3JtIGNvbmRpdGlvbnNcbiAgICAod2VhdGhlci53aW5kU3BlZWQgPiA0MCAmJiB3ZWF0aGVyLndlYXRoZXJDb2RlID49IDgwKTsgLy8gSGlnaCB3aW5kcyArIHJhaW5cblxuICByZXR1cm4ge1xuICAgIHdlYXRoZXIsXG4gICAgbWFya2V0RGF0YToge1xuICAgICAgY3VycmVudFRlbXA6IHdlYXRoZXIudGVtcGVyYXR1cmUsXG4gICAgICBpbnZlbnRvcnksXG4gICAgICBpc0h1cnJpY2FuZUFsZXJ0LFxuICAgICAgdGltZXN0YW1wOiB3ZWF0aGVyLnRpbWVzdGFtcCxcbiAgICB9LFxuICB9O1xufVxuXG4vKipcbiAqIEZvcm1hdHMgdGhlIHRpbWVzdGFtcCBmb3IgZGlzcGxheVxuICovXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0U3luY1RpbWUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gIHJldHVybiBkYXRlLnRvTG9jYWxlVGltZVN0cmluZyhcImVuLVVTXCIsIHtcbiAgICBob3VyOiBcIjItZGlnaXRcIixcbiAgICBtaW51dGU6IFwiMi1kaWdpdFwiLFxuICAgIHNlY29uZDogXCIyLWRpZ2l0XCIsXG4gIH0pO1xufVxuXG4vKipcbiAqIEdldHMgZnJvc3QgcmlzayBsZXZlbCBiYXNlZCBvbiB0ZW1wZXJhdHVyZSBhbmQgY29uZGl0aW9uc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RnJvc3RSaXNrTGV2ZWwoXG4gIHRlbXA6IG51bWJlcixcbiAgaHVtaWRpdHk6IG51bWJlcixcbiAgd2luZFNwZWVkOiBudW1iZXJcbik6IHsgbGV2ZWw6IFwibm9uZVwiIHwgXCJsb3dcIiB8IFwibW9kZXJhdGVcIiB8IFwiaGlnaFwiIHwgXCJjcml0aWNhbFwiOyBkZXNjcmlwdGlvbjogc3RyaW5nIH0ge1xuICAvLyBIaWdoIGh1bWlkaXR5ICsgbG93IHdpbmQgKyBsb3cgdGVtcCA9IGhpZ2hlciBmcm9zdCByaXNrXG4gIC8vIFdpbmQgYWN0dWFsbHkgcmVkdWNlcyBmcm9zdCByaXNrIGJ5IHByZXZlbnRpbmcgcmFkaWF0aXZlIGNvb2xpbmdcblxuICBpZiAodGVtcCA+IDQwKSB7XG4gICAgcmV0dXJuIHsgbGV2ZWw6IFwibm9uZVwiLCBkZXNjcmlwdGlvbjogXCJObyBmcm9zdCByaXNrXCIgfTtcbiAgfVxuXG4gIGlmICh0ZW1wID4gMzYpIHtcbiAgICBpZiAod2luZFNwZWVkIDwgNSAmJiBodW1pZGl0eSA+IDcwKSB7XG4gICAgICByZXR1cm4geyBsZXZlbDogXCJsb3dcIiwgZGVzY3JpcHRpb246IFwiU2xpZ2h0IGZyb3N0IHBvc3NpYmxlIG92ZXJuaWdodFwiIH07XG4gICAgfVxuICAgIHJldHVybiB7IGxldmVsOiBcIm5vbmVcIiwgZGVzY3JpcHRpb246IFwiTm8gc2lnbmlmaWNhbnQgZnJvc3Qgcmlza1wiIH07XG4gIH1cblxuICBpZiAodGVtcCA+IDMyKSB7XG4gICAgaWYgKHdpbmRTcGVlZCA8IDUgJiYgaHVtaWRpdHkgPiA2MCkge1xuICAgICAgcmV0dXJuIHsgbGV2ZWw6IFwibW9kZXJhdGVcIiwgZGVzY3JpcHRpb246IFwiRnJvc3QgbGlrZWx5IG92ZXJuaWdodFwiIH07XG4gICAgfVxuICAgIHJldHVybiB7IGxldmVsOiBcImxvd1wiLCBkZXNjcmlwdGlvbjogXCJMaWdodCBmcm9zdCBwb3NzaWJsZVwiIH07XG4gIH1cblxuICBpZiAodGVtcCA+IDI4KSB7XG4gICAgaWYgKHdpbmRTcGVlZCA8IDEwKSB7XG4gICAgICByZXR1cm4geyBsZXZlbDogXCJoaWdoXCIsIGRlc2NyaXB0aW9uOiBcIkhhcmQgZnJlZXplIGV4cGVjdGVkXCIgfTtcbiAgICB9XG4gICAgcmV0dXJuIHsgbGV2ZWw6IFwibW9kZXJhdGVcIiwgZGVzY3JpcHRpb246IFwiRnJlZXplIGNvbmRpdGlvbnNcIiB9O1xuICB9XG5cbiAgLy8gQmVsb3cgMjjCsEYgLSBjcml0aWNhbCBmb3IgY2l0cnVzXG4gIHJldHVybiB7IGxldmVsOiBcImNyaXRpY2FsXCIsIGRlc2NyaXB0aW9uOiBcIkNSSVRJQ0FMOiBDaXRydXMgZGFtYWdlIGxpa2VseVwiIH07XG59XG4iXX0=