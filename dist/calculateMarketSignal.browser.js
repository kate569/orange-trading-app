"use strict";
// Browser-compatible version of calculateMarketSignal
// Uses embedded rules instead of filesystem access
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateMarketSignalBrowser = calculateMarketSignalBrowser;
// Embedded market rules (from constants/market_rules.json)
const MARKET_RULES = {
    theme: "Orange Juice Trading",
    frost_rule: {
        critical_temp_f: 28,
        min_duration_hours: 4,
        target_counties: ["Polk", "Highlands", "Lake"],
    },
    inventory_multipliers: {
        under_35m: 2.0,
        "35_45m": 1.5,
        over_55m: 0.7,
    },
    win_rates: {
        la_nina_double_hit: 0.79,
        volatility_pre_frost: 0.79,
        real_frost: 0.76,
    },
};
// Additional market context multipliers
const LA_NINA_MULTIPLIER = 1.4;
const HURRICANE_FALSE_ALARM_WIN_RATE = 0.71;
const MAX_WIN_PROBABILITY = 0.95;
/**
 * Calculates market signal based on temperature, frost duration, inventory levels,
 * and market context (La Niña, Hurricane conditions).
 * Browser-compatible version with embedded rules.
 *
 * @param currentTemp - Current temperature in Fahrenheit
 * @param hoursBelow28 - Number of hours temperature has been below 28°F
 * @param currentInventory - Current inventory in millions (e.g., 30 for 30M)
 * @param marketContext - Optional market context parameters (La Niña, Hurricane)
 * @returns MarketSignalResultWithInsight with win probability, recommended action, and insight
 */
function calculateMarketSignalBrowser(currentTemp, hoursBelow28, currentInventory, marketContext) {
    const { frost_rule, inventory_multipliers, win_rates } = MARKET_RULES;
    // Default market context
    const context = marketContext ?? {
        isLaNina: false,
        isHurricaneActive: false,
        hurricaneCenterFarFromPolk: false,
    };
    // Check for Hurricane False Alarm first - this overrides all other logic
    if (context.isHurricaneActive && context.hurricaneCenterFarFromPolk) {
        return {
            winProbability: HURRICANE_FALSE_ALARM_WIN_RATE,
            recommendedAction: "SELL/SHORT (False Alarm)",
            isHurricaneFalseAlarm: true,
            isLaNinaActive: context.isLaNina,
            insight: {
                frostCondition: "Hurricane override active - frost conditions bypassed",
                inventoryCondition: "Hurricane override active - inventory conditions bypassed",
                multiplierApplied: 1.0,
                baseWinRate: HURRICANE_FALSE_ALARM_WIN_RATE,
                hurricaneEffect: `Hurricane center >100mi from Polk County = False Alarm. Historical win rate: ${HURRICANE_FALSE_ALARM_WIN_RATE * 100}%`,
            },
        };
    }
    // Determine base win probability based on frost conditions
    let baseWinProbability;
    let frostCondition;
    const isBelowCriticalTemp = currentTemp < frost_rule.critical_temp_f;
    const hasSufficientDuration = hoursBelow28 >= frost_rule.min_duration_hours;
    if (isBelowCriticalTemp && hasSufficientDuration) {
        // Real frost conditions met
        baseWinProbability = win_rates.real_frost;
        frostCondition = `Real frost detected: ${currentTemp}°F for ${hoursBelow28}+ hours`;
    }
    else if (isBelowCriticalTemp) {
        // Pre-frost volatility (below critical temp but not enough duration yet)
        baseWinProbability = win_rates.volatility_pre_frost;
        frostCondition = `Pre-frost volatility: ${currentTemp}°F (need ${frost_rule.min_duration_hours}h duration)`;
    }
    else {
        // No frost signal - use a baseline probability
        baseWinProbability = 0.5;
        frostCondition = `No frost signal: ${currentTemp}°F above ${frost_rule.critical_temp_f}°F threshold`;
    }
    // Determine inventory multiplier
    let inventoryMultiplier;
    let inventoryCondition;
    if (currentInventory < 35) {
        inventoryMultiplier = inventory_multipliers.under_35m;
        inventoryCondition = `Inventory < 35M triggers ${inventoryMultiplier}x risk multiplier`;
    }
    else if (currentInventory <= 45) {
        inventoryMultiplier = inventory_multipliers["35_45m"];
        inventoryCondition = `Inventory 35-45M triggers ${inventoryMultiplier}x multiplier`;
    }
    else if (currentInventory > 55) {
        inventoryMultiplier = inventory_multipliers.over_55m;
        inventoryCondition = `Inventory > 55M triggers ${inventoryMultiplier}x (reduced) multiplier`;
    }
    else {
        // Between 45 and 55, use neutral multiplier
        inventoryMultiplier = 1.0;
        inventoryCondition = `Inventory 45-55M: neutral position (1.0x multiplier)`;
    }
    // Calculate win probability with inventory multiplier
    let winProbability = baseWinProbability * inventoryMultiplier;
    // Apply La Niña effect
    let laNinaEffect;
    if (context.isLaNina) {
        winProbability *= LA_NINA_MULTIPLIER;
        laNinaEffect = `La Niña active (ONI < -0.5): ${LA_NINA_MULTIPLIER}x multiplier applied. Historical "Double Hit" win rate: ${win_rates.la_nina_double_hit * 100}%`;
    }
    // Cap at maximum probability
    winProbability = Math.min(winProbability, MAX_WIN_PROBABILITY);
    // Determine recommended action based on inventory and conditions
    let recommendedAction;
    if (currentInventory < 35) {
        recommendedAction = "Double Position";
    }
    else if (currentInventory <= 45 && isBelowCriticalTemp) {
        recommendedAction = "Increase Position";
    }
    else if (currentInventory > 55) {
        recommendedAction = "Reduce Position";
    }
    else if (isBelowCriticalTemp && hasSufficientDuration) {
        recommendedAction = "Hold Position";
    }
    else {
        recommendedAction = "Monitor";
    }
    // Hurricane warning without false alarm condition
    let hurricaneEffect;
    if (context.isHurricaneActive && !context.hurricaneCenterFarFromPolk) {
        hurricaneEffect = "Hurricane warning active - monitoring for potential impact on Polk County";
    }
    return {
        winProbability: Math.round(winProbability * 100) / 100,
        recommendedAction,
        isHurricaneFalseAlarm: false,
        isLaNinaActive: context.isLaNina,
        insight: {
            frostCondition,
            inventoryCondition,
            multiplierApplied: inventoryMultiplier,
            baseWinRate: baseWinProbability,
            laNinaEffect,
            hurricaneEffect,
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsY3VsYXRlTWFya2V0U2lnbmFsLmJyb3dzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2FsY3VsYXRlTWFya2V0U2lnbmFsLmJyb3dzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHNEQUFzRDtBQUN0RCxtREFBbUQ7O0FBeUZuRCxvRUF3SEM7QUFsS0QsMkRBQTJEO0FBQzNELE1BQU0sWUFBWSxHQUFnQjtJQUNoQyxLQUFLLEVBQUUsc0JBQXNCO0lBQzdCLFVBQVUsRUFBRTtRQUNWLGVBQWUsRUFBRSxFQUFFO1FBQ25CLGtCQUFrQixFQUFFLENBQUM7UUFDckIsZUFBZSxFQUFFLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLENBQUM7S0FDL0M7SUFDRCxxQkFBcUIsRUFBRTtRQUNyQixTQUFTLEVBQUUsR0FBRztRQUNkLFFBQVEsRUFBRSxHQUFHO1FBQ2IsUUFBUSxFQUFFLEdBQUc7S0FDZDtJQUNELFNBQVMsRUFBRTtRQUNULGtCQUFrQixFQUFFLElBQUk7UUFDeEIsb0JBQW9CLEVBQUUsSUFBSTtRQUMxQixVQUFVLEVBQUUsSUFBSTtLQUNqQjtDQUNGLENBQUM7QUFFRix3Q0FBd0M7QUFDeEMsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLENBQUM7QUFDL0IsTUFBTSw4QkFBOEIsR0FBRyxJQUFJLENBQUM7QUFDNUMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUM7QUFRakM7Ozs7Ozs7Ozs7R0FVRztBQUNILFNBQWdCLDRCQUE0QixDQUMxQyxXQUFtQixFQUNuQixZQUFvQixFQUNwQixnQkFBd0IsRUFDeEIsYUFBbUM7SUFFbkMsTUFBTSxFQUFFLFVBQVUsRUFBRSxxQkFBcUIsRUFBRSxTQUFTLEVBQUUsR0FBRyxZQUFZLENBQUM7SUFFdEUseUJBQXlCO0lBQ3pCLE1BQU0sT0FBTyxHQUF3QixhQUFhLElBQUk7UUFDcEQsUUFBUSxFQUFFLEtBQUs7UUFDZixpQkFBaUIsRUFBRSxLQUFLO1FBQ3hCLDBC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bXBhdGlibGUgdmVyc2lvbiBvZiBjYWxjdWxhdGVNYXJrZXRTaWduYWxcbi8vIFVzZXMgZW1iZWRkZWQgcnVsZXMgaW5zdGVhZCBvZiBmaWxlc3lzdGVtIGFjY2Vzc1xuXG5pbnRlcmZhY2UgRnJvc3RSdWxlIHtcbiAgY3JpdGljYWxfdGVtcF9mOiBudW1iZXI7XG4gIG1pbl9kdXJhdGlvbl9ob3VyczogbnVtYmVyO1xuICB0YXJnZXRfY291bnRpZXM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgSW52ZW50b3J5TXVsdGlwbGllcnMge1xuICB1bmRlcl8zNW06IG51bWJlcjtcbiAgXCIzNV80NW1cIjogbnVtYmVyO1xuICBvdmVyXzU1bTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgV2luUmF0ZXMge1xuICBsYV9uaW5hX2RvdWJsZV9oaXQ6IG51bWJlcjtcbiAgdm9sYXRpbGl0eV9wcmVfZnJvc3Q6IG51bWJlcjtcbiAgcmVhbF9mcm9zdDogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgTWFya2V0UnVsZXMge1xuICB0aGVtZTogc3RyaW5nO1xuICBmcm9zdF9ydWxlOiBGcm9zdFJ1bGU7XG4gIGludmVudG9yeV9tdWx0aXBsaWVyczogSW52ZW50b3J5TXVsdGlwbGllcnM7XG4gIHdpbl9yYXRlczogV2luUmF0ZXM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFya2V0U2lnbmFsUmVzdWx0IHtcbiAgd2luUHJvYmFiaWxpdHk6IG51bWJlcjtcbiAgcmVjb21tZW5kZWRBY3Rpb246IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTaWduYWxJbnNpZ2h0IHtcbiAgZnJvc3RDb25kaXRpb246IHN0cmluZztcbiAgaW52ZW50b3J5Q29uZGl0aW9uOiBzdHJpbmc7XG4gIG11bHRpcGxpZXJBcHBsaWVkOiBudW1iZXI7XG4gIGJhc2VXaW5SYXRlOiBudW1iZXI7XG4gIGxhTmluYUVmZmVjdD86IHN0cmluZztcbiAgaHVycmljYW5lRWZmZWN0Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1hcmtldENvbnRleHRQYXJhbXMge1xuICBpc0xhTmluYTogYm9vbGVhbjtcbiAgaXNIdXJyaWNhbmVBY3RpdmU6IGJvb2xlYW47XG4gIGh1cnJpY2FuZUNlbnRlckZhckZyb21Qb2xrOiBib29sZWFuO1xufVxuXG4vLyBFbWJlZGRlZCBtYXJrZXQgcnVsZXMgKGZyb20gY29uc3RhbnRzL21hcmtldF9ydWxlcy5qc29uKVxuY29uc3QgTUFSS0VUX1JVTEVTOiBNYXJrZXRSdWxlcyA9IHtcbiAgdGhlbWU6IFwiT3JhbmdlIEp1aWNlIFRyYWRpbmdcIixcbiAgZnJvc3RfcnVsZToge1xuICAgIGNyaXRpY2FsX3RlbXBfZjogMjgsXG4gICAgbWluX2R1cmF0aW9uX2hvdXJzOiA0LFxuICAgIHRhcmdldF9jb3VudGllczogW1wiUG9sa1wiLCBcIkhpZ2hsYW5kc1wiLCBcIkxha2VcIl0sXG4gIH0sXG4gIGludmVudG9yeV9tdWx0aXBsaWVyczoge1xuICAgIHVuZGVyXzM1bTogMi4wLFxuICAgIFwiMzVfNDVtXCI6IDEuNSxcbiAgICBvdmVyXzU1bTogMC43LFxuICB9LFxuICB3aW5fcmF0ZXM6IHtcbiAgICBsYV9uaW5hX2RvdWJsZV9oaXQ6IDAuNzksXG4gICAgdm9sYXRpbGl0eV9wcmVfZnJvc3Q6IDAuNzksXG4gICAgcmVhbF9mcm9zdDogMC43NixcbiAgfSxcbn07XG5cbi8vIEFkZGl0aW9uYWwgbWFya2V0IGNvbnRleHQgbXVsdGlwbGllcnNcbmNvbnN0IExBX05JTkFfTVVMVElQTElFUiA9IDEuNDtcbmNvbnN0IEhVUlJJQ0FORV9GQUxTRV9BTEFSTV9XSU5fUkFURSA9IDAuNzE7XG5jb25zdCBNQVhfV0lOX1BST0JBQklMSVRZID0gMC45NTtcblxuZXhwb3J0IGludGVyZmFjZSBNYXJrZXRTaWduYWxSZXN1bHRXaXRoSW5zaWdodCBleHRlbmRzIE1hcmtldFNpZ25hbFJlc3VsdCB7XG4gIGluc2lnaHQ6IFNpZ25hbEluc2lnaHQ7XG4gIGlzSHVycmljYW5lRmFsc2VBbGFybTogYm9vbGVhbjtcbiAgaXNMYU5pbmFBY3RpdmU6IGJvb2xlYW47XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlcyBtYXJrZXQgc2lnbmFsIGJhc2VkIG9uIHRlbXBlcmF0dXJlLCBmcm9zdCBkdXJhdGlvbiwgaW52ZW50b3J5IGxldmVscyxcbiAqIGFuZCBtYXJrZXQgY29udGV4dCAoTGEgTmnDsWEsIEh1cnJpY2FuZSBjb25kaXRpb25zKS5cbiAqIEJyb3dzZXItY29tcGF0aWJsZSB2ZXJzaW9uIHdpdGggZW1iZWRkZWQgcnVsZXMuXG4gKlxuICogQHBhcmFtIGN1cnJlbnRUZW1wIC0gQ3VycmVudCB0ZW1wZXJhdHVyZSBpbiBGYWhyZW5oZWl0XG4gKiBAcGFyYW0gaG91cnNCZWxvdzI4IC0gTnVtYmVyIG9mIGhvdXJzIHRlbXBlcmF0dXJlIGhhcyBiZWVuIGJlbG93IDI4wrBGXG4gKiBAcGFyYW0gY3VycmVudEludmVudG9yeSAtIEN1cnJlbnQgaW52ZW50b3J5IGluIG1pbGxpb25zIChlLmcuLCAzMCBmb3IgMzBNKVxuICogQHBhcmFtIG1hcmtldENvbnRleHQgLSBPcHRpb25hbCBtYXJrZXQgY29udGV4dCBwYXJhbWV0ZXJzIChMYSBOacOxYSwgSHVycmljYW5lKVxuICogQHJldHVybnMgTWFya2V0U2lnbmFsUmVzdWx0V2l0aEluc2lnaHQgd2l0aCB3aW4gcHJvYmFiaWxpdHksIHJlY29tbWVuZGVkIGFjdGlvbiwgYW5kIGluc2lnaHRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZU1hcmtldFNpZ25hbEJyb3dzZXIoXG4gIGN1cnJlbnRUZW1wOiBudW1iZXIsXG4gIGhvdXJzQmVsb3cyODogbnVtYmVyLFxuICBjdXJyZW50SW52ZW50b3J5OiBudW1iZXIsXG4gIG1hcmtldENvbnRleHQ/OiBNYXJrZXRDb250ZXh0UGFyYW1zXG4pOiBNYXJrZXRTaWduYWxSZXN1bHRXaXRoSW5zaWdodCB7XG4gIGNvbnN0IHsgZnJvc3RfcnVsZSwgaW52ZW50b3J5X211bHRpcGxpZXJzLCB3aW5fcmF0ZXMgfSA9IE1BUktFVF9SVUxFUztcblxuICAvLyBEZWZhdWx0IG1hcmtldCBjb250ZXh0XG4gIGNvbnN0IGNvbnRleHQ6IE1hcmtldENvbnRleHRQYXJhbXMgPSBtYXJrZXRDb250ZXh0ID8/IHtcbiAgICBpc0xhTmluYTogZmFsc2UsXG4gICAgaXNIdXJyaWNhbmVBY3RpdmU6IGZhbHNlLFxuICAgIGh1cnJpY2FuZUNlbnRlckZhckZyb21Qb2xrOiBmYWxzZSxcbiAgfTtcblxuICAvLyBDaGVjayBmb3IgSHVycmljYW5lIEZhbHNlIEFsYXJtIGZpcnN0IC0gdGhpcyBvdmVycmlkZXMgYWxsIG90aGVyIGxvZ2ljXG4gIGlmIChjb250ZXh0LmlzSHVycmljYW5lQWN0aXZlICYmIGNvbnRleHQuaHVycmljYW5lQ2VudGVyRmFyRnJvbVBvbGspIHtcbiAgICByZXR1cm4ge1xuICAgICAgd2luUHJvYmFiaWxpdHk6IEhVUlJJQ0FORV9GQUxTRV9BTEFSTV9XSU5fUkFURSxcbiAgICAgIHJlY29tbWVuZGVkQWN0aW9uOiBcIlNFTEwvU0hPUlQgKEZhbHNlIEFsYXJtKVwiLFxuICAgICAgaXNIdXJyaWNhbmVGYWxzZUFsYXJtOiB0cnVlLFxuICAgICAgaXNMYU5pbmFBY3RpdmU6IGNvbnRleHQuaXNMYU5pbmEsXG4gICAgICBpbnNpZ2h0OiB7XG4gICAgICAgIGZyb3N0Q29uZGl0aW9uOiBcIkh1cnJpY2FuZSBvdmVycmlkZSBhY3RpdmUgLSBmcm9zdCBjb25kaXRpb25zIGJ5cGFzc2VkXCIsXG4gICAgICAgIGludmVudG9yeUNvbmRpdGlvbjogXCJIdXJyaWNhbmUgb3ZlcnJpZGUgYWN0aXZlIC0gaW52ZW50b3J5IGNvbmRpdGlvbnMgYnlwYXNzZWRcIixcbiAgICAgICAgbXVsdGlwbGllckFwcGxpZWQ6IDEuMCxcbiAgICAgICAgYmFzZVdpblJhdGU6IEhVUlJJQ0FORV9GQUxTRV9BTEFSTV9XSU5fUkFURSxcbiAgICAgICAgaHVycmljYW5lRWZmZWN0OiBgSHVycmljYW5lIGNlbnRlciA+MTAwbWkgZnJvbSBQb2xrIENvdW50eSA9IEZhbHNlIEFsYXJtLiBIaXN0b3JpY2FsIHdpbiByYXRlOiAke0hVUlJJQ0FORV9GQUxTRV9BTEFSTV9XSU5fUkFURSAqIDEwMH0lYCxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8vIERldGVybWluZSBiYXNlIHdpbiBwcm9iYWJpbGl0eSBiYXNlZCBvbiBmcm9zdCBjb25kaXRpb25zXG4gIGxldCBiYXNlV2luUHJvYmFiaWxpdHk6IG51bWJlcjtcbiAgbGV0IGZyb3N0Q29uZGl0aW9uOiBzdHJpbmc7XG5cbiAgY29uc3QgaXNCZWxvd0NyaXRpY2FsVGVtcCA9IGN1cnJlbnRUZW1wIDwgZnJvc3RfcnVsZS5jcml0aWNhbF90ZW1wX2Y7XG4gIGNvbnN0IGhhc1N1ZmZpY2llbnREdXJhdGlvbiA9IGhvdXJzQmVsb3cyOCA+PSBmcm9zdF9ydWxlLm1pbl9kdXJhdGlvbl9ob3VycztcblxuICBpZiAoaXNCZWxvd0NyaXRpY2FsVGVtcCAmJiBoYXNTdWZmaWNpZW50RHVyYXRpb24pIHtcbiAgICAvLyBSZWFsIGZyb3N0IGNvbmRpdGlvbnMgbWV0XG4gICAgYmFzZVdpblByb2JhYmlsaXR5ID0gd2luX3JhdGVzLnJlYWxfZnJvc3Q7XG4gICAgZnJvc3RDb25kaXRpb24gPSBgUmVhbCBmcm9zdCBkZXRlY3RlZDogJHtjdXJyZW50VGVtcH3CsEYgZm9yICR7aG91cnNCZWxvdzI4fSsgaG91cnNgO1xuICB9IGVsc2UgaWYgKGlzQmVsb3dDcml0aWNhbFRlbXApIHtcbiAgICAvLyBQcmUtZnJvc3Qgdm9sYXRpbGl0eSAoYmVsb3cgY3JpdGljYWwgdGVtcCBidXQgbm90IGVub3VnaCBkdXJhdGlvbiB5ZXQpXG4gICAgYmFzZVdpblByb2JhYmlsaXR5ID0gd2luX3JhdGVzLnZvbGF0aWxpdHlfcHJlX2Zyb3N0O1xuICAgIGZyb3N0Q29uZGl0aW9uID0gYFByZS1mcm9zdCB2b2xhdGlsaXR5OiAke2N1cnJlbnRUZW1wfcKwRiAobmVlZCAke2Zyb3N0X3J1bGUubWluX2R1cmF0aW9uX2hvdXJzfWggZHVyYXRpb24pYDtcbiAgfSBlbHNlIHtcbiAgICAvLyBObyBmcm9zdCBzaWduYWwgLSB1c2UgYSBiYXNlbGluZSBwcm9iYWJpbGl0eVxuICAgIGJhc2VXaW5Qcm9iYWJpbGl0eSA9IDAuNTtcbiAgICBmcm9zdENvbmRpdGlvbiA9IGBObyBmcm9zdCBzaWduYWw6ICR7Y3VycmVudFRlbXB9wrBGIGFib3ZlICR7ZnJvc3RfcnVsZS5jcml0aWNhbF90ZW1wX2Z9wrBGIHRocmVzaG9sZGA7XG4gIH1cblxuICAvLyBEZXRlcm1pbmUgaW52ZW50b3J5IG11bHRpcGxpZXJcbiAgbGV0IGludmVudG9yeU11bHRpcGxpZXI6IG51bWJlcjtcbiAgbGV0IGludmVudG9yeUNvbmRpdGlvbjogc3RyaW5nO1xuXG4gIGlmIChjdXJyZW50SW52ZW50b3J5IDwgMzUpIHtcbiAgICBpbnZlbnRvcnlNdWx0aXBsaWVyID0gaW52ZW50b3J5X211bHRpcGxpZXJzLnVuZGVyXzM1bTtcbiAgICBpbnZlbnRvcnlDb25kaXRpb24gPSBgSW52ZW50b3J5IDwgMzVNIHRyaWdnZXJzICR7aW52ZW50b3J5TXVsdGlwbGllcn14IHJpc2sgbXVsdGlwbGllcmA7XG4gIH0gZWxzZSBpZiAoY3VycmVudEludmVudG9yeSA8PSA0NSkge1xuICAgIGludmVudG9yeU11bHRpcGxpZXIgPSBpbnZlbnRvcnlfbXVsdGlwbGllcnNbXCIzNV80NW1cIl07XG4gICAgaW52ZW50b3J5Q29uZGl0aW9uID0gYEludmVudG9yeSAzNS00NU0gdHJpZ2dlcnMgJHtpbnZlbnRvcnlNdWx0aXBsaWVyfXggbXVsdGlwbGllcmA7XG4gIH0gZWxzZSBpZiAoY3VycmVudEludmVudG9yeSA+IDU1KSB7XG4gICAgaW52ZW50b3J5TXVsdGlwbGllciA9IGludmVudG9yeV9tdWx0aXBsaWVycy5vdmVyXzU1bTtcbiAgICBpbnZlbnRvcnlDb25kaXRpb24gPSBgSW52ZW50b3J5ID4gNTVNIHRyaWdnZXJzICR7aW52ZW50b3J5TXVsdGlwbGllcn14IChyZWR1Y2VkKSBtdWx0aXBsaWVyYDtcbiAgfSBlbHNlIHtcbiAgICAvLyBCZXR3ZWVuIDQ1IGFuZCA1NSwgdXNlIG5ldXRyYWwgbXVsdGlwbGllclxuICAgIGludmVudG9yeU11bHRpcGxpZXIgPSAxLjA7XG4gICAgaW52ZW50b3J5Q29uZGl0aW9uID0gYEludmVudG9yeSA0NS01NU06IG5ldXRyYWwgcG9zaXRpb24gKDEuMHggbXVsdGlwbGllcilgO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIHdpbiBwcm9iYWJpbGl0eSB3aXRoIGludmVudG9yeSBtdWx0aXBsaWVyXG4gIGxldCB3aW5Qcm9iYWJpbGl0eSA9IGJhc2VXaW5Qcm9iYWJpbGl0eSAqIGludmVudG9yeU11bHRpcGxpZXI7XG5cbiAgLy8gQXBwbHkgTGEgTmnDsWEgZWZmZWN0XG4gIGxldCBsYU5pbmFFZmZlY3Q6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgaWYgKGNvbnRleHQuaXNMYU5pbmEpIHtcbiAgICB3aW5Qcm9iYWJpbGl0eSAqPSBMQV9OSU5BX01VTFRJUExJRVI7XG4gICAgbGFOaW5hRWZmZWN0ID0gYExhIE5pw7FhIGFjdGl2ZSAoT05JIDwgLTAuNSk6ICR7TEFfTklOQV9NVUxUSVBMSUVSfXggbXVsdGlwbGllciBhcHBsaWVkLiBIaXN0b3JpY2FsIFwiRG91YmxlIEhpdFwiIHdpbiByYXRlOiAke3dpbl9yYXRlcy5sYV9uaW5hX2RvdWJsZV9oaXQgKiAxMDB9JWA7XG4gIH1cblxuICAvLyBDYXAgYXQgbWF4aW11bSBwcm9iYWJpbGl0eVxuICB3aW5Qcm9iYWJpbGl0eSA9IE1hdGgubWluKHdpblByb2JhYmlsaXR5LCBNQVhfV0lOX1BST0JBQklMSVRZKTtcblxuICAvLyBEZXRlcm1pbmUgcmVjb21tZW5kZWQgYWN0aW9uIGJhc2VkIG9uIGludmVudG9yeSBhbmQgY29uZGl0aW9uc1xuICBsZXQgcmVjb21tZW5kZWRBY3Rpb246IHN0cmluZztcblxuICBpZiAoY3VycmVudEludmVudG9yeSA8IDM1KSB7XG4gICAgcmVjb21tZW5kZWRBY3Rpb24gPSBcIkRvdWJsZSBQb3NpdGlvblwiO1xuICB9IGVsc2UgaWYgKGN1cnJlbnRJbnZlbnRvcnkgPD0gNDUgJiYgaXNCZWxvd0NyaXRpY2FsVGVtcCkge1xuICAgIHJlY29tbWVuZGVkQWN0aW9uID0gXCJJbmNyZWFzZSBQb3NpdGlvblwiO1xuICB9IGVsc2UgaWYgKGN1cnJlbnRJbnZlbnRvcnkgPiA1NSkge1xuICAgIHJlY29tbWVuZGVkQWN0aW9uID0gXCJSZWR1Y2UgUG9zaXRpb25cIjtcbiAgfSBlbHNlIGlmIChpc0JlbG93Q3JpdGljYWxUZW1wICYmIGhhc1N1ZmZpY2llbnREdXJhdGlvbikge1xuICAgIHJlY29tbWVuZGVkQWN0aW9uID0gXCJIb2xkIFBvc2l0aW9uXCI7XG4gIH0gZWxzZSB7XG4gICAgcmVjb21tZW5kZWRBY3Rpb24gPSBcIk1vbml0b3JcIjtcbiAgfVxuXG4gIC8vIEh1cnJpY2FuZSB3YXJuaW5nIHdpdGhvdXQgZmFsc2UgYWxhcm0gY29uZGl0aW9uXG4gIGxldCBodXJyaWNhbmVFZmZlY3Q6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgaWYgKGNvbnRleHQuaXNIdXJyaWNhbmVBY3RpdmUgJiYgIWNvbnRleHQuaHVycmljYW5lQ2VudGVyRmFyRnJvbVBvbGspIHtcbiAgICBodXJyaWNhbmVFZmZlY3QgPSBcIkh1cnJpY2FuZSB3YXJuaW5nIGFjdGl2ZSAtIG1vbml0b3JpbmcgZm9yIHBvdGVudGlhbCBpbXBhY3Qgb24gUG9sayBDb3VudHlcIjtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgd2luUHJvYmFiaWxpdHk6IE1hdGgucm91bmQod2luUHJvYmFiaWxpdHkgKiAxMDApIC8gMTAwLFxuICAgIHJlY29tbWVuZGVkQWN0aW9uLFxuICAgIGlzSHVycmljYW5lRmFsc2VBbGFybTogZmFsc2UsXG4gICAgaXNMYU5pbmFBY3RpdmU6IGNvbnRleHQuaXNMYU5pbmEsXG4gICAgaW5zaWdodDoge1xuICAgICAgZnJvc3RDb25kaXRpb24sXG4gICAgICBpbnZlbnRvcnlDb25kaXRpb24sXG4gICAgICBtdWx0aXBsaWVyQXBwbGllZDogaW52ZW50b3J5TXVsdGlwbGllcixcbiAgICAgIGJhc2VXaW5SYXRlOiBiYXNlV2luUHJvYmFiaWxpdHksXG4gICAgICBsYU5pbmFFZmZlY3QsXG4gICAgICBodXJyaWNhbmVFZmZlY3QsXG4gICAgfSxcbiAgfTtcbn1cbiJdfQ==